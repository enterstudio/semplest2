@model Semplest.Core.Models.ReportIndexModel 
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>
       <table border =1>
       <tr>
           <td>
                   <ul id="reportTreeView" style="margin: 5px; height: 1000px;">
                   </ul>
           </td>
       </tr>
       </table>
<script type="text/javascript">
    $(document).ready(function () {
        $("#reportTreeView").dynatree({
            checkbox: true,
            selectMode: 3,
            title: "Reports",
            onSelect: function (select, node) {
                // Get a list of all selected nodes, and convert to a key array:        
                var selKeys = $.map(node.tree.getSelectedNodes(), function (node) { return node.data.key; });
                var selTexts = $.map(node.tree.getSelectedNodes(), function (node) { return node.data.title; });
                var selEngines = $.map($('.engnieBox'), function (node) { if (node.checked) return node.id; });
                //alert(selEngines);
                //alert(selKeys);
                //alert(selKeys.join(", "));        
                // Get a list of all selected TOP nodes        
                var selRootNodes = node.tree.getSelectedNodes(true);
                // ... and convert to a key array:        
                var selRootKeys = $.map(selRootNodes, function (node) { return node.data.key; });
                //alert(selRootKeys.join(", "));    
                //alert(selTexts.join(", "));
                //alert(selRootNodes.join(", "));  
                $('#EngineFks').val(selEngines.join(", "));
                $('#PromotionFks').val(selKeys.join(", "));
                $('#PromotionName').val(selTexts.join(", "));
            },
            onDblClick: function (node, event) {
                node.toggleSelect();
            },
            onKeydown: function (node, event) {
                if (event.which == 32) {
                    node.toggleSelect();
                    return false;
                }
            },
            onActivate: function (node) {
                //        alert(node.getKeyPath());        
                if (node.data.url)
                    window.open(node.data.url, node.data.target);
            },
            onDeactivate: function (node) {

            },
            onFocus: function (node) {

            },
            onBlur: function (node) {

            }
        });
        SideBarBus();
    });

    function LoadSubItems(subitems, mainGroup, subitem, childNode) {
        for (var subitem1 in subitems) {
            var childSubNode = childNode.addChild({ title: subitems[subitem1].Name, key: subitems[subitem1].Id });
            if (subitems[subitem1].SubItems.length > 0)
                LoadSubItems(subitems[subitem1].SubItems, 0, 0, childSubNode, subitems);
        }
    }

    function SideBarBus() {
        $.getJSON("/Tree/BuildSubItems", {}, function (data) {
            var rootNode = $("#reportTreeView").dynatree("getRoot");
            for (var mainGroup in data) {
                for (var subitem in data[mainGroup].SubItems) {
                    var childNode = rootNode.addChild({
                        title: data[mainGroup].SubItems[subitem].Name,
                        tooltip: data[mainGroup].SubItems[subitem].Name,
                        key: data[mainGroup].SubItems[subitem].Id
                    });
                    LoadSubItems(data[mainGroup].SubItems[subitem].SubItems, mainGroup, subitem, childNode);
                }
            }
            $("#reportTreeView").dynatree("getRoot").visit(function (node) {
                node.expand(true);
            });
        });
    }

</script>

<script id="treeview-template" type="text/kendo-ui-template">
            #= item.text #
            # if (!item.items) { #
                <a class='delete-link' href='\#'></a>
            # } #
</script>
<script id="treeview-checkbox-template" type="text/kendo-ui-template">
 <input type="checkbox" name="promotion[#= item.Id #]" value="#= item.Id #" />
</script>